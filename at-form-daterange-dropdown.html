<link rel="import" href="../tangere/tangere.html">
<link rel="import" href="../at-i18n/at-i18n-behavior.html">
<link rel="import" href="../at-carbon-date-picker/at-carbon-date-picker.html">
<link rel="import" href="../at-carbon-moment/momentjs-import.html">
<link rel="import" href="../at-core-dropdown/at-core-dropdown.html">

<dom-module id="at-form-daterange-dropdown">
  <template>
    <style>
      polymer-date-picker-calendar {
        display: block;
        float: left;
      }

      /*.daterangepicker {
        position: relative;
        top: 4px;
        min-width: 175px;
      }

      .daterangepicker:before {
        content: '';
        position: absolute;
        top: -2px;
        display: inline-block;
        @apply(--at-form-daterange-dropdown-border-before);
      }

      .daterangepicker:after {
        content: '';
        position: absolute;
        top: -1px;
        display: inline-block;
        @apply(--at-form-daterange-dropdown-border-after);
      }*/

      .daterangepicker .ranges {
        @apply(--shadow-elevation-2dp);
        @apply(--at-picker-background);
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        padding: 4px 8px;
        margin: 4px;
        min-width: 175px;
      }

      .range-item {
        padding: 4px 8px;
        margin: 2px 0;
        cursor: pointer;
        border-radius: 5px;
        @apply(--at-form-label-font);
        @apply(--at-text-selected);
      }

      .daterangepicker .ranges .range-item.active,
      .daterangepicker .ranges .range-item:hover {
        @apply(--at-text-primary-selected);
      }

      .hidden {
        display: none;
      }

      .at-carbon-picker-container {
        @apply(--at-picker-background);
        @apply(--shadow-elevation-2dp);
        margin: 4px;
      }
    </style>

    <at-core-dropdown id="coreDropdown" class="daterangepicker" position="bottomRight">
      <div id="rangeDiv" class="horizontal layout">
        <div hidden$="{{!showRanges}}" class="ranges">
          <div class="range-item" on-click="menuItemClicked" value="today">{{T("Today")}}</div>
          <div class="range-item" on-click="menuItemClicked" value="yesterday">{{T("Yesterday")}}</div>
          <div class="range-item" on-click="menuItemClicked" value="last7days">{{T("Last 7 Days")}}</div>
          <div class="range-item" on-click="menuItemClicked" value="last30days">{{T("Last 30 Days")}}</div>
          <div class="range-item" on-click="menuItemClicked" value="thisMonth">{{T("This Month")}}</div>
          <div class="range-item" on-click="menuItemClicked" value="lastMonth">{{T("Last Month")}}</div>
          <div class="range-item" on-click="menuItemClicked" value="custom">{{T("Custom")}}</div>
        </div>
        <div class="at-carbon-picker-container">
          <at-carbon-date-picker id="calendarStart" mode="start-range" hidden="true" start-date="{{startDate}}" end-date="{{endDate}}" format="[[format]]"></at-carbon-date-picker>
        </div>
        <div class="at-carbon-picker-container">
          <at-carbon-date-picker id="calendarEnd" mode="end-range" hidden="true" start-date="{{startDate}}" end-date="{{endDate}}" format="[[format]]"></at-carbon-date-picker>
        </div>
      </div>
    </at-core-dropdown>
  </template>
</dom-module>
<script>
  Polymer({
    is: "at-form-daterange-dropdown",
    behaviors: [Tangere.behaviors.i18n],
    properties: {
      startDate: {
        type: String,
        value: '',
        notify: true,
        observer: 'startDateChanged'
      },
      endDate: {
        type: String,
        value: '',
        notify: true,
        observer: 'endDateChanged'
      },
      selected: {
        type: String,
        value: '',
        observer: 'selectedChanged'
      },
      showRanges: {
        type: Boolean,
        value: false
      },
      orientation: {
        type: String,
        value: 'horizontal'
      },
      format: {
        type: String,
        value: '',
        title: 'Format'
      }
    },
    _getFormat: function() {
      if (!this.format) {
        this.format = this._localizedFormat("date");
      }
      return this.format;
    },
    ready: function() {
      this.format = this._getFormat();
      this._boundResizeHandler = function() {};

      this.toggleClass('horizontal', this.orientation === 'horizontal', this.$.rangeDiv);
      this.toggleClass('vertical', this.orientation === 'vertical', this.$.rangeDiv);

      var resizeUnboundHandler = function(event) {
        var windowWidth = window.innerWidth;
        var dropdownWidth = this.$.rangeDiv.getBoundingClientRect().width;
        var dropdownLeft = this.$.rangeDiv.getBoundingClientRect().left;
        if (this.orientation === 'horizontal') {
          if (dropdownWidth + dropdownLeft > windowWidth) {
            this.toggleClass('horizontal', false, this.$.rangeDiv);
            this.toggleClass('vertical', true, this.$.rangeDiv);
            this.orientation = 'vertical';
          } else {
            this.toggleClass('horizontal', true, this.$.rangeDiv);
            this.toggleClass('vertical', false, this.$.rangeDiv);
          }
        } else if (this.orientation === 'vertical') {
          if (dropdownWidth * 3 + dropdownLeft > windowWidth) {
            this.toggleClass('horizontal', false, this.$.rangeDiv);
            this.toggleClass('vertical', true, this.$.rangeDiv);
          } else {
            this.toggleClass('horizontal', true, this.$.rangeDiv);
            this.toggleClass('vertical', false, this.$.rangeDiv);
            this.orientation = 'horizontal';
          }
        }
      }

      var boundResizeHandler = resizeUnboundHandler.bind(this);
      window.addEventListener('resize', boundResizeHandler);
      this._boundResizeHandler = boundResizeHandler;
    },
    open: function(event) {
      var self = this;
      var coreDropdown = this.$.coreDropdown;
      if (coreDropdown.hasAttribute('dropdown-open')) {
        return;
      }
      Polymer.dom(coreDropdown).setAttribute('dropdown-open', true);
      coreDropdown._updateDropdownPosition(event.target || event.srcElement);
      coreDropdown.show(event);
      self._boundResizeHandler();
    },
    close: function(event) {
      if (!coreDropdown.hasAttribute('dropdown-open')) {
        return;
      }
      Polymer.dom(coreDropdown).removeAttribute('dropdown-open');
      coreDropdown.hide();
    },
    toggle: function(event) {
      var coreDropdown = this.$.coreDropdown;
      if (coreDropdown.hasAttribute('dropdown-open')) {
        this.close(event);
      } else {
        this.open(event);
      }
    },
    newMoment: function() {
      return moment();
    },
    // this function handles the click event on menu items
    menuItemClicked: function(event) {
      var value = event.target.getAttribute('value');

      if (value !== 'custom') {
        this.close(event);
      }

      this.selected = value;
    },
    selectedChanged: function(newValue, oldValue) {
      if (newValue === "") {
        return;
      }

      var activeItem = this.$$('.range-item.active');

      if (activeItem) {
        Polymer.dom(activeItem).classList.remove('active');
      }
      var calendarStart = this.$.calendarStart;
      this.toggleAttribute('hidden', this.selected !== 'custom', calendarStart);
      var calendarEnd = this.$.calendarEnd;
      this.toggleAttribute('hidden', this.selected !== 'custom', calendarEnd);
      if (this._boundResizeHandler !== undefined) {
        this._boundResizeHandler();
      }

      this._isInternalUpdate = true;
      switch (this.selected) {
        case 'today':
          this.startDate = this._formatDate(this.newMoment());
          this.endDate = this._formatDate(this.newMoment());
          break;
        case 'yesterday':
          this.startDate = this._formatDate(this.newMoment().subtract(1, "days"));
          this.endDate = this._formatDate(this.newMoment().subtract(1, "days"));
          break;
        case 'last7days':
          this.startDate = this._formatDate(this.newMoment().subtract(6, "days"));
          this.endDate = this._formatDate(this.newMoment());
          break;
        case 'last30days':
          this.startDate = this._formatDate(this.newMoment().subtract(30, "days"));
          this.endDate = this._formatDate(this.newMoment());
          break;
        case 'thisMonth':
          this.startDate = this._formatDate(this.newMoment().startOf("month"));
          this.endDate = this._formatDate(this.newMoment().endOf("month"));
          break;
        case 'lastMonth':
          this.startDate = this._formatDate(this.newMoment().subtract(1, "months").startOf("month"));
          this.endDate = this._formatDate(this.newMoment().subtract(1, "months").endOf("month"));
          break;
        case 'custom':
          // for initialization purposes (first time) startDate and endDate are set to today
          // subject to change
          if (this.startDate === '') {
            this.startDate = this._formatDate(this.newMoment());
          }
          if (this.endDate === '') {
            this.endDate = this._formatDate(this.newMoment());
          }
          break;
      }
      this._isInternalUpdate = false;

      if (this.selected) {
        var liElem = this.$$('.range-item[value=' + this.selected + ']');
        if (liElem) {
          Polymer.dom(liElem).classList.add('active');
        }
      }
    },
    _formatDate: function(moment) {
      if (!this.format) {
        this.format = this._localizedFormat("date");
      }

      return moment.format(this.format);
    },
    startDateChanged: function(newValue) {
      if (this._isInternalUpdate) {
        return;
      }
      if (newValue === "") {
        return;
      }
      var format = this._getFormat();
      var startMomemt = moment(newValue, format);
      if (startMomemt.isValid()) {
        if (this.endDate) {
          endMoment = moment(this.endDate, format);

          if (startMomemt.isAfter(endMoment)) {
            this._isInternalUpdate = true;
            this.startDate = this.endDate;
            this.endDate = newValue;
            this._isInternalUpdate = false;
          }
        }
      }
      this._setSelected();
    },
    endDateChanged: function(newValue) {
      if (this._isInternalUpdate) {
        return;
      }
      if (newValue === "") {
        return;
      }
      var format = this._getFormat();
      var endMomemt = moment(newValue, format);
      if (this.startDate) {
        startMoment = moment(this.startDate, format);

        if (endMomemt.isBefore(startMoment)) {
          this._isInternalUpdate = true;
          this.endDate = this.startDate;
          this.startDate = newValue;
          this._isInternalUpdate = false;
        }
      }
      this._setSelected();
    },
    _setSelected: function() {
      if (this.startDate !== "" && this.endDate !== "") {
        this.selected = "custom";
      }
    }
  });
</script>
